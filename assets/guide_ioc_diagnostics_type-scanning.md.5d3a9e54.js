import{_ as s,c as n,o as a,a as e}from"./app.5b13aa3a.js";const d=JSON.parse('{"title":"Type Scanning Diagnostics","description":"","frontmatter":{},"headers":[{"level":2,"title":"Assert for Assembly Loading Failures","slug":"assert-for-assembly-loading-failures","link":"#assert-for-assembly-loading-failures","children":[]},{"level":2,"title":"What did Lamar scan?","slug":"what-did-lamar-scan","link":"#what-did-lamar-scan","children":[]}],"relativePath":"guide/ioc/diagnostics/type-scanning.md"}'),l={name:"guide/ioc/diagnostics/type-scanning.md"},t=e(`<h1 id="type-scanning-diagnostics" tabindex="-1">Type Scanning Diagnostics <a class="header-anchor" href="#type-scanning-diagnostics" aria-hidden="true">#</a></h1><p>Type scanning and conventional auto-registration is a very powerful feature in Lamar, but it has been frequently troublesome to users when things go wrong. To try to alleviate problems, Lamar has some functionality for detecting and diagnosing problems with type scanning, mostly related to Assembly&#39;s being missing.</p><h2 id="assert-for-assembly-loading-failures" tabindex="-1">Assert for Assembly Loading Failures <a class="header-anchor" href="#assert-for-assembly-loading-failures" aria-hidden="true">#</a></h2><p>At its root, most type scanning and auto-registration schemes in .Net frameworks rely on the <a href="https://msdn.microsoft.com/en-us/library/system.reflection.assembly.getexportedtypes%28v=vs.110%29.aspx" target="_blank" rel="noreferrer">Assembly.GetExportedTypes()</a> method. Unfortunately, that method can be brittle and fail whenever any dependency of that Assembly cannot be loaded into the current process, even if your application has no need for that dependency. In Lamar, you can use this method to assert the presence of any assembly load exceptions during type scanning:</p><p><a id="snippet-sample_assert-no-type-scanning-failures"></a></p><div class="language-cs"><button title="Copy Code" class="copy"></button><span class="lang">cs</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">TypeRepository</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AssertNoTypeScanningFailures</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span></code></pre></div><p><sup><a href="https://github.com/JasperFx/lamar/blob/master/src/StructureMap.Testing/Graph/Scanning/TypeRepositoryTester.cs#L45-L47" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_assert-no-type-scanning-failures" title="Start of snippet">anchor</a></sup></p><p>The method above will throw an exception listing all the Assembly&#39;s that failed during the call to <code>GetExportedTypes()</code> only if there were any failures. Use this method during your application bootstrapping if you want it to fail fast with any type scanning problems.</p><h2 id="what-did-lamar-scan" tabindex="-1">What did Lamar scan? <a class="header-anchor" href="#what-did-lamar-scan" aria-hidden="true">#</a></h2><p>Confusion of type scanning has been a constant problem with Lamar usage over the years -- especially if users are trying to dynamically load assemblies from the file system for extensibility. In order to see into what Lamar has done with type scanning, 4.0 introduces the <code>Container.WhatDidIScan()</code> method.</p><p>Let&#39;s say that you have a <code>Container</code> that is set up with at least two different scanning operations like this sample from the Lamar unit tests:</p><p><a id="snippet-sample_whatdidiscan"></a></p><div class="language-cs"><button title="Copy Code" class="copy"></button><span class="lang">cs</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">container</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Container</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">_</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    _</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Scan</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">x</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">TheCallingAssembly</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WithDefaultConventions</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">RegisterConcreteTypesAgainstTheFirstInterface</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">SingleImplementationsOfInterface</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    _</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Scan</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">x</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// Give your scanning operation a descriptive name</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// to help the diagnostics to be more useful</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Description </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Second Scanner</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AssembliesFromApplicationBaseDirectory</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">assem</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> assem</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FullName</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Contains</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Widget</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ConnectImplementationsToTypesClosing</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">typeof</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">IService</span><span style="color:#89DDFF;">&lt;&gt;));</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddAllTypesOf</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">IWidget</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WriteLine</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">container</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WhatDidIScan</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span></code></pre></div><p><sup><a href="https://github.com/JasperFx/lamar/blob/master/src/Lamar.Testing/IoC/Diagnostics/WhatDidIScan_smoke_tests.cs#L16-L43" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_whatdidiscan" title="Start of snippet">anchor</a></sup><a id="snippet-sample_whatdidiscan-1"></a></p><div class="language-cs"><button title="Copy Code" class="copy"></button><span class="lang">cs</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">container</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Container</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">_</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    _</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Scan</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">x</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">TheCallingAssembly</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WithDefaultConventions</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">RegisterConcreteTypesAgainstTheFirstInterface</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">SingleImplementationsOfInterface</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    _</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Scan</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">x</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// Give your scanning operation a descriptive name</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// to help the diagnostics to be more useful</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Description </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Second Scanner</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AssembliesFromApplicationBaseDirectory</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">assem</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> assem</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FullName</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Contains</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Widget</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ConnectImplementationsToTypesClosing</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">typeof</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">IService</span><span style="color:#89DDFF;">&lt;&gt;));</span></span>
<span class="line"><span style="color:#A6ACCD;">        x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddAllTypesOf</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">IWidget</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Debug</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WriteLine</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">container</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WhatDidIScan</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span></code></pre></div><p><sup><a href="https://github.com/JasperFx/lamar/blob/master/src/StructureMap.Testing/WhatDidIScan_smoke_tester.cs#L14-L39" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_whatdidiscan-1" title="Start of snippet">anchor</a></sup></p><p>The resulting textual report is shown below:</p><p><em>Sorry for the formatting and color of the text, but the markdown engine does <strong>not</strong> like the textual report</em></p><p><a id="snippet-sample_whatdidiscan-result"></a></p><div class="language-cs"><button title="Copy Code" class="copy"></button><span class="lang">cs</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">All Scanners</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">================================================================</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Scanner #1</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Assemblies</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">----------</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Conventions</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--------</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Default I[Name]/[Name] registration convention</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Register all concrete types against the first interface (if any) that they implement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Register any single implementation of any interface against that interface</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Second Scanner</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Assemblies</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">----------</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.GenericWidgets, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget2, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget3, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget4, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget5, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Conventions</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--------</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Connect all implementations of open generic type IService&lt;T&gt;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Find and register all types implementing StructureMap.Testing.Widget.IWidget</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">*/</span></span>
<span class="line"></span></code></pre></div><p><sup><a href="https://github.com/JasperFx/lamar/blob/master/src/Lamar.Testing/IoC/Diagnostics/WhatDidIScan_smoke_tests.cs#L87-L120" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_whatdidiscan-result" title="Start of snippet">anchor</a></sup><a id="snippet-sample_whatdidiscan-result-1"></a></p><div class="language-cs"><button title="Copy Code" class="copy"></button><span class="lang">cs</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">All Scanners</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">================================================================</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Scanner #1</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Assemblies</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">----------</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Conventions</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--------</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Default I[Name]/[Name] registration convention</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Register all concrete types against the first interface (if any) that they implement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Register any single implementation of any interface against that interface</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Second Scanner</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Assemblies</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">----------</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.GenericWidgets, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget2, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget3, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget4, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* StructureMap.Testing.Widget5, Version=4.0.0.51243, Culture=neutral, PublicKeyToken=null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Conventions</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--------</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Connect all implementations of open generic type IService&lt;T&gt;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">* Find and register all types implementing StructureMap.Testing.Widget.IWidget</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">*/</span></span>
<span class="line"></span></code></pre></div><p><sup><a href="https://github.com/JasperFx/lamar/blob/master/src/StructureMap.Testing/WhatDidIScan_smoke_tester.cs#L43-L74" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_whatdidiscan-result-1" title="Start of snippet">anchor</a></sup></p><p>The textual report will show:</p><ol><li>All the scanning operations (calls to <code>Registry.Scan()</code>) with a descriptive name, either one supplied by you or the <code>Registry</code> type and an order number.</li><li>All the assemblies that were part of the scanning operation including the assembly name, version, and a warning if <code>Assembly.GetExportedTypes()</code> failed on that assembly.</li><li>All the configured scanning conventions inside of the scanning operation</li></ol><p><code>WhatDidIScan()</code> does not at this time show any type filters or exclusions that may be part of the assembly scanner.</p><p>See also: <a href="/lamar/guide/ioc/registration/auto-registration-and-conventions.html">Auto-Registration and Conventions</a></p>`,27),p=[t];function o(i,c,r,y,F,D){return a(),n("div",null,p)}const A=s(l,[["render",o]]);export{d as __pageData,A as default};
